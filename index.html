<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>高負載硬體測試</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/1.0.35/ua-parser.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --primary:#1e90ff;
  --bg:#0a0a0a;
  --card-bg:#111;
  --font:'Plus Jakarta Sans',sans-serif;
}
body{
  margin:0;
  font-family:var(--font);
  background:var(--bg);
  color:#fff;
  display:flex;
  justify-content:center;
}
.wrapper{
  width:95%;
  max-width:1100px;
  padding:30px 20px;
}
.header{text-align:center;margin-bottom:30px;}
.header h1{
  font-size:2.2rem;color:var(--primary);
  margin:0;text-shadow:0 0 10px var(--primary);
}
.header p{font-size:1rem;color:#ccc;}
.bench-container{
  background:var(--card-bg);
  padding:25px;
  border-radius:12px;
  box-shadow:0 0 20px rgba(0,0,0,0.7);
}
.progress-box{margin:25px 0;}
.bar-bg{
  background:#222;height:14px;border-radius:7px;overflow:hidden;
}
.bar-fill{
  height:100%;width:0%;
  background:linear-gradient(90deg,var(--primary),#00ffff);
  transition:width 0.3s linear;
}
.realtime-stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:15px;
  margin-top:20px;
}
.stat-card{
  background:#0f0f0f;
  padding:15px;
  border-radius:10px;
  border:1px solid #333;
  text-align:center;
}
.stat-label{font-size:0.8rem;color:#888;margin-bottom:8px;}
.stat-val{font-size:1.2rem;font-weight:bold;color:var(--primary);}
.btn-run{
  background:var(--primary);
  color:#fff;
  font-size:1.3rem;
  padding:14px;
  border:none;
  width:100%;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
}
.btn-run:hover{background:#00ffff;color:#000;}
#ui-done{text-align:center;padding:25px;border:2px solid #00ff00;border-radius:12px;margin-top:25px;}
#final-code{font-size:2.5rem;letter-spacing:10px;color:#fff;margin-top:10px;}
#admin-zone{margin-top:50px;padding-top:30px;border-top:1px dashed #444;}
.adm-input{
  background:#111;border:1px solid #444;color:#fff;padding:12px;width:100%;margin:8px 0 15px;border-radius:8px;
}
.report{
  width:100%;border-collapse:collapse;margin-top:15px;overflow-x:auto;display:block;
}
.report td,.report th{border:1px solid #333;padding:10px;text-align:left;}
.report th{color:var(--primary);}
canvas{display:none;}
@media(max-width:600px){
  .header h1{font-size:1.6rem;}
  .stat-val{font-size:1rem;}
  .btn-run{font-size:1.1rem;padding:12px;}
  #final-code{font-size:2rem;}
}
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <h1>硬體高負載測試</h1>
    <p>CPU / GPU / RAM 真實高負載測試</p>
  </div>
  <div class="bench-container">
    <div id="ui-idle">
      <p style="color:var(--primary);">⚠️ 系統將進入極高負載狀態，請確認散熱與電源安全。</p>
      <p>測試輪數：30 | 預估耗時：15~20 分鐘</p>
      <button class="btn-run" onclick="startStressTest()">開始測試</button>
    </div>
    <div id="ui-running" style="display:none;">
      <div style="text-align:center;color:var(--primary);" id="task-name">初始化測試...</div>
      <div class="progress-box">
        <div class="bar-bg"><div class="bar-fill" id="bar"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:0.85rem;margin-top:5px;">
          <span id="pc-text">0%</span>
          <span id="round-text">ROUND 0/30</span>
        </div>
      </div>
      <div class="realtime-stats">
        <div class="stat-card"><div class="stat-label">CPU Stress</div><div class="stat-val" id="stat-cpu">0 ms</div></div>
        <div class="stat-card"><div class="stat-label">RAM Stress</div><div class="stat-val" id="stat-ram">0 ms</div></div>
        <div class="stat-card"><div class="stat-label">GPU Stress</div><div class="stat-val" id="stat-gpu">0 ms</div></div>
      </div>
    </div>
    <div id="ui-done">
      <h2 style="color:#00ff00;">測試完成</h2>
      <p>測試報告已生成，驗證碼：</p>
      <div id="final-code">------</div>
    </div>
  </div>
  <div id="admin-zone">
    <h3>ADMIN REPORT</h3>
    <input type="password" id="pass" class="adm-input" placeholder="ACCESS KEY">
    <input type="text" id="code" class="adm-input" placeholder="USER AUTH CODE">
    <button class="btn-run" style="font-size:1rem;padding:12px;" onclick="getStressReport()">查看完整報告</button>
    <div id="report-view"></div>
  </div>
</div>

<canvas id="stress-canvas" width="3840" height="2160"></canvas>

<script>
// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyCTWMvsv6JylnjCGYvznnfrXnTSAV7JUXk",
    authDomain: "tnt-device-info.firebaseapp.com",
    projectId: "tnt-device-info",
    storageBucket: "tnt-device-info.appspot.com",
    messagingSenderId: "434641237799",
    appId: "1:434641237799:web:7b00cf8dd372e29891db02"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const TOTAL_ROUNDS = 30;
let logs = {cpu:[], ram:[], gpu:[]};

async function startStressTest(){
  document.getElementById('ui-idle').style.display='none';
  document.getElementById('ui-running').style.display='block';

  const cores = navigator.hardwareConcurrency || 4;
  const workers = [];
  
  for(let r=1;r<=TOTAL_ROUNDS;r++){
    document.getElementById('round-text').innerText=`ROUND ${r}/${TOTAL_ROUNDS}`;
    
    // CPU 高負載：啟動 Worker 佔滿所有核心
    document.getElementById('task-name').innerText="CPU Stress...";
    let cpuTime = await runCpuStress(cores);
    logs.cpu.push(cpuTime);
    document.getElementById('stat-cpu').innerText=`${cpuTime} ms`;

    // RAM 高負載
    document.getElementById('task-name').innerText="RAM Stress...";
    let ramTime = await runRamStress();
    logs.ram.push(ramTime);
    document.getElementById('stat-ram').innerText=`${ramTime} ms`;

    // GPU 高負載
    document.getElementById('task-name').innerText="GPU Stress...";
    let gpuTime = await runGpuStress();
    logs.gpu.push(gpuTime);
    document.getElementById('stat-gpu').innerText=`${gpuTime} ms`;

    let progress = Math.round((r/TOTAL_ROUNDS)*100);
    document.getElementById('bar').style.width=progress+'%';
    document.getElementById('pc-text').innerText=progress+'%';
    await new Promise(r=>setTimeout(r,100)); // 渲染間隔
  }

  // 生成 6 位代碼
  const authCode = Math.random().toString(36).substring(2,8).toUpperCase();
  document.getElementById('final-code').innerText=authCode;

  // 儲存 Firebase
  const parser = new UAParser();
  await db.collection('stress_test').doc(authCode).set({
    logs,
    ua: parser.getResult(),
    time: new Date().toISOString()
  });

  document.getElementById('ui-running').style.display='none';
  document.getElementById('ui-done').style.display='block';
}

// CPU 高負載
function runCpuStress(cores){
  return new Promise(resolve=>{
    const start = performance.now();
    const workerCode = `onmessage=function(){let sum=0;for(let i=0;i<1e7;i++){sum+=Math.sqrt(i);}postMessage(sum);}`;
    const blob = new Blob([workerCode],{type:'application/javascript'});
    const url = URL.createObjectURL(blob);
    let completed = 0;
    for(let i=0;i<cores;i++){
      const w = new Worker(url);
      w.onmessage=function(){completed++;if(completed===cores)resolve(Math.round(performance.now()-start));};
    }
  });
}

// RAM 高負載
function runRamStress(){
  return new Promise(resolve=>{
    const start = performance.now();
    const arr = [];
    for(let i=0;i<100;i++){
      arr.push(new Float64Array(1024*1024*5)); // 每個 ~40MB
      for(let j=0;j<arr[i].length;j+=100000) arr[i][j]=Math.random();
    }
    resolve(Math.round(performance.now()-start));
  });
}

// GPU 高負載
function runGpuStress(){
  return new Promise(resolve=>{
    const start = performance.now();
    const canvas = document.getElementById('stress-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const particles = [];
    for(let i=0;i<50000;i++) particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height});
    for(let i=0;i<100;i++){
      particles.forEach(p=>{p.x+=Math.sin(performance.now()/1000+i);p.y+=Math.cos(performance.now()/1000+i);});
    }
    resolve(Math.round(performance.now()-start));
  });
}

// 管理員查報告
async function getStressReport(){
  if(document.getElementById('pass').value!=='Oliver_5490') return alert('ACCESS DENIED');
  const code = document.getElementById('code').value.toUpperCase();
  const doc = await db.collection('stress_test').doc(code).get();
  if(!doc.exists) return alert('INVALID CODE');
  const d = doc.data();
  document.getElementById('report-view').innerHTML=`
    <table class="report">
      <tr><th colspan="2">HARDWARE ENVIRONMENT</th></tr>
      <tr><td>OS/DEVICE</td><td>${d.ua.os.name} | ${d.ua.device.model||'PC'}</td></tr>
      <tr><td>ENGINE</td><td>${d.ua.browser.name} ${d.ua.browser.version}</td></tr>
      <tr><th colspan="2">STRESS TEST LOGS (ms)</th></tr>
      <tr><td>CPU</td><td>${d.logs.cpu.join(', ')}</td></tr>
      <tr><td>RAM</td><td>${d.logs.ram.join(', ')}</td></tr>
      <tr><td>GPU</td><td>${d.logs.gpu.join(', ')}</td></tr>
    </table>
  `;
}
</script>
</body>
</html>